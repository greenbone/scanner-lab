apiVersion: v1
kind: PersistentVolume
metadata:
  name: scanconfig-data-pv
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/var/lib/gvm/data-objects/gvmd/22.04/scan-configs"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: scanconfig-data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: manual
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: openvas-data-pv
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/var/lib/openvas/plugins"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openvas-data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: manual
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: notus-data-pv
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/var/lib/notus"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: notus-data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: manual
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openvas
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openvas
  template:
    metadata:
      name: openvas
      labels:
        app: openvas
    spec:
      volumes:
      - name: redis-socket
        emptyDir: {}
      - name: nasl-plugins
        persistentVolumeClaim:
          claimName: openvas-data-pvc
      - name: notus-data
        persistentVolumeClaim:
          claimName: notus-data-pvc
      - name: openvas-config
        emptyDir: {}
      - name: scan-config 
        persistentVolumeClaim:
          claimName: scanconfig-data-pvc 
      - name: ospd-config
        emptyDir: {}
      - name: cacerts
        emptyDir: {}
      initContainers:
      - name: mqtt-broker-openvas-fix
        image: greenbone/ospd-openvas:unstable
        imagePullPolicy: Always
        volumeMounts:
          - name: openvas-config
            mountPath: /mnt/ovc
        command: ['sh', '-c']
        args: ["sed 's/mqtt-broker/localhost/' /etc/openvas/openvas.conf > /mnt/ovc/openvas.conf; cp /etc/openvas/openvas_log.conf /mnt/ovc/"]
      - name: ospd-tcp-configuration
        image: greenbone/ospd-openvas:unstable
        imagePullPolicy: Always
        volumeMounts:
          - name: ospd-config
            mountPath: /mnt/ovc
        command: ['sh', '-c']
        args: ["sed 's/unix_socket =.*/bind_address = 0.0.0.0\\nport = 4242/' /etc/gvm/ospd-openvas.conf > /mnt/ovc/ospd-openvas.conf"]
      - name: create-self-signed-certificates
        image: greenbone/ospd-openvas:unstable
        imagePullPolicy: Always
        volumeMounts:
          - name: cacerts
            mountPath: /mnt/vlg
        command: ['sh', '-c']
        args: ["mkdir -p /mnt/vlg/CA && mkdir -p /mnt/vlg/private/CA && openssl req -x509 -newkey rsa:4096 -keyout /mnt/vlg/private/CA/serverkey.pem -out /mnt/vlg/CA/cacert.pem -nodes -subj '/CN=localhost' -addext 'subjectAltName = DNS:localhost' -days 365 && cp /mnt/vlg/CA/cacert.pem /mnt/vlg/CA/servercert.pem && chown -R ospd-openvas:ospd-openvas /mnt/vlg/"]

      containers:
      - name: broker
        image: greenbone/mqtt-broker
        imagePullPolicy: Always
      - name: notus
        image: greenbone/notus-scanner:unstable
        imagePullPolicy: Always
        volumeMounts:
        - name: notus-data
          mountPath: /var/lib/notus
        command: ["notus-scanner", "-f", "--disable-hashsum-verification=True"]
      - name: redis
        image: greenbone/redis-server
        imagePullPolicy: Always
        volumeMounts:
        - name: redis-socket
          mountPath: /run/redis
      - name: ospd
        image: greenbone/ospd-openvas:unstable
        imagePullPolicy: Always
        ports:
          - containerPort: 4242
        volumeMounts:
        - name: scan-config
          mountPath: /usr/local/src/policies
        - name: redis-socket
          mountPath: /run/redis
        - name: nasl-plugins
          mountPath: /var/lib/openvas/plugins
        - name: notus-data
          mountPath: /var/lib/notus
        - name: openvas-config
          mountPath: /etc/openvas
        - name: ospd-config
          mountPath: /etc/gvm/
        - name: cacerts
          mountPath: /var/lib/gvm
        securityContext:
          capabilities:
            add:
              - NET_ADMIN
              - NET_RAW
---
apiVersion: v1
kind: Service
metadata:
  name: ospd-tcp
spec:
  selector:
    app: openvas
  ports:
    - protocol: TCP
      port: 4242
      targetPort: 4242
